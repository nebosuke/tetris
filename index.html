<html>
<head>
<title>テトリス</title>
<style>
body {
    background-color: white;
    margin: 0 auto;
    padding: 0;
}
.field {
    margin: 24px 0;
    border: 1px solid white;
    text-align: center;
    color: white;
    font-family: monospace;
    font-size: 44px;
    line-height: 22px;;
}
.block {
    display: inline-block;
    width: 32px;
    height: 32px;
    border: 1px solid #333;
}
.block0 {
    background-color: black;
}
.block1 {
    background-color: lightskyblue;
}
.block2 {
    background-color: yellow;
}
.block3 {
    background-color: green;
}
.block4 {
    background-color: red;
}
.block5 {
    background-color: blue;
}
.block6 {
    background-color: orange;
}
.block7 {
    background-color: purple;
}
</style>
</head>
<body>
<div class="field" id="field"></div>
<script>
const HEIGHT = 20;
const WIDTH = 10;

let field = new Array(HEIGHT)
for (let h = 0; h < HEIGHT; h++) {
    field[h] = new Array(WIDTH);
    for (let w = 0; w < WIDTH; w++) {
        field[h][w] = 0;
    }
}

let dropping = makeNextBlock();
let nextBlock = makeNextBlock();

function makeNextBlock() {
    return {
        'x': 3,
        'y': 0,
        'type': Math.floor(Math.random() * 8),
        'rotation': 0
    }
}

// 現在のブロックに落ちている途中のブロックを上書きで描画する
// 結果が可能な場合はtrue
function overlayDropping(display) {
    switch (dropping.type) {
    case 1:
        return overlayTetI(display);
    case 2:
        return overlayTetO(display);
    case 3:
        return overlayTetS(display);
    case 4:
        return overlayTetZ(display);
    case 5:
        return overlayTetL(display);
    case 6:
        return overlayTetJ(display);
    case 7:
        return overlayTetT(display);
    default:
        return false;
    }
}

function overlayTetI(display) {
    if (dropping.rotation == 1 || dropping.rotation == 3) {
        if (
            isEmpty(display, dropping.x, dropping.y + 2) &&
            isEmpty(display, dropping.x, dropping.y + 1) &&
            isEmpty(display, dropping.x, dropping.y    ) &&
            isEmpty(display, dropping.x, dropping.y - 1)
        ) {
            display[dropping.y + 2][dropping.x] = 1;
            display[dropping.y + 1][dropping.x] = 1;
            display[dropping.y + 0][dropping.x] = 1;
            display[dropping.y - 1][dropping.x] = 1;
            return true;
        }
    } else {
        if (isEmpty(display, dropping.x - 1, dropping.y) &&
            isEmpty(display, dropping.x + 0, dropping.y) &&
            isEmpty(display, dropping.x + 1, dropping.y) &&
            isEmpty(display, dropping.x + 2, dropping.y)) {
            display[dropping.y][dropping.x - 1] = 1;
            display[dropping.y][dropping.x + 0] = 1;
            display[dropping.y][dropping.x + 1] = 1;
            display[dropping.y][dropping.x + 2] = 1;
            return true;
        }
    }
    return false;
}

function overlayTetO(display) {
    if (
        isEmpty(display, dropping.x    , dropping.y + 1) &&
        isEmpty(display, dropping.x + 1, dropping.y + 1) &&
        isEmpty(display, dropping.x    , dropping.y    ) &&
        isEmpty(display, dropping.x + 1, dropping.y    )
    ) {
        display[dropping.y + 1][dropping.x + 0] = 2;
        display[dropping.y + 1][dropping.x + 1] = 2;
        display[dropping.y + 0][dropping.x + 0] = 2;
        display[dropping.y + 0][dropping.x + 1] = 2;
        return true;
    }
    return false;
}

function overlayTetS(display) {
    if (dropping.rotation == 1 || dropping.rotation == 3) {
       if (
           isEmpty(display, dropping.x - 1, dropping.y + 1) &&
           isEmpty(display, dropping.x + 0, dropping.y + 1) &&
           isEmpty(display, dropping.x + 0, dropping.y + 0) &&
           isEmpty(display, dropping.x + 1, dropping.y + 0)
        ) {
            display[dropping.y + 1][dropping.x - 1] = 3;
            display[dropping.y + 1][dropping.x + 0] = 3;
            display[dropping.y + 0][dropping.x + 0] = 3;
            display[dropping.y + 0][dropping.x + 1] = 3;
            return true;
        }
    } else {
        if (
            isEmpty(display, dropping.x - 1, dropping.y - 1) &&
            isEmpty(display, dropping.x - 1, dropping.y + 0) &&
            isEmpty(display, dropping.x + 0, dropping.y + 0) &&
            isEmpty(display, dropping.x + 0, dropping.y + 1)
        ) {
            display[dropping.y - 1][dropping.x - 1] = 3;
            display[dropping.y + 0][dropping.x - 1] = 3;
            display[dropping.y + 0][dropping.x + 0] = 3;
            display[dropping.y + 1][dropping.x + 0] = 3;
            return true;
        }
    }
    return false;
}

function overlayTetZ(display) {
    if (dropping.rotation == 1 || dropping.rotation == 3) {
       if (
           isEmpty(display, dropping.x - 1, dropping.y + 0) &&
           isEmpty(display, dropping.x + 0, dropping.y + 0) &&
           isEmpty(display, dropping.x + 0, dropping.y + 1) &&
           isEmpty(display, dropping.x + 1, dropping.y + 1)
        ) {
            display[dropping.y + 0][dropping.x - 1] = 4;
            display[dropping.y + 0][dropping.x + 0] = 4;
            display[dropping.y + 1][dropping.x + 0] = 4;
            display[dropping.y + 1][dropping.x + 1] = 4;
            return true;
        }
    } else {
        if (
            isEmpty(display, dropping.x - 1, dropping.y + 1) &&
            isEmpty(display, dropping.x - 1, dropping.y + 0) &&
            isEmpty(display, dropping.x + 0, dropping.y + 0) &&
            isEmpty(display, dropping.x + 0, dropping.y - 1)
        ) {
            display[dropping.y + 1][dropping.x - 1] = 4;
            display[dropping.y + 0][dropping.x - 1] = 4;
            display[dropping.y + 0][dropping.x + 0] = 4;
            display[dropping.y - 1][dropping.x + 0] = 4;
            return true;
        }
    }
    return false;
}

function overlayTetL(display) {
    if (dropping.rotation == 0) {
        if (
            isEmpty(display, dropping.x + 0, dropping.y - 1) &&
            isEmpty(display, dropping.x + 0, dropping.y + 0) &&
            isEmpty(display, dropping.x + 1, dropping.y + 0) &&
            isEmpty(display, dropping.x + 2, dropping.y + 0)
        ) {
            display[dropping.y - 1][dropping.x + 0] = 5;
            display[dropping.y + 0][dropping.x + 0] = 5;
            display[dropping.y + 0][dropping.x + 1] = 5;
            display[dropping.y + 0][dropping.x + 2] = 5;
            return true;
        }
    } else if (dropping.rotation == 1) {
        if (
            isEmpty(display, dropping.x + 0, dropping.y + 2) &&
            isEmpty(display, dropping.x + 0, dropping.y + 1) &&
            isEmpty(display, dropping.x + 0, dropping.y + 0) &&
            isEmpty(display, dropping.x + 1, dropping.y + 0)
        ) {
            display[dropping.y + 2][dropping.x + 0] = 5;
            display[dropping.y + 1][dropping.x + 0] = 5;
            display[dropping.y + 0][dropping.x + 0] = 5;
            display[dropping.y + 0][dropping.x + 1] = 5;
            return true;
        }
    } else if (dropping.rotation == 2) {
        if (
            isEmpty(display, dropping.x - 2, dropping.y + 0) &&
            isEmpty(display, dropping.x - 1, dropping.y + 0) &&
            isEmpty(display, dropping.x + 0, dropping.y + 0) &&
            isEmpty(display, dropping.x + 0, dropping.y + 1)
        ) {
            display[dropping.y + 0][dropping.x - 2] = 5;
            display[dropping.y + 0][dropping.x - 1] = 5;
            display[dropping.y + 0][dropping.x + 0] = 5;
            display[dropping.y + 1][dropping.x + 0] = 5;
            return true;
        }
    } else if (dropping.rotation == 3) {
        if (
            isEmpty(display, dropping.x - 1, dropping.y + 0) &&
            isEmpty(display, dropping.x + 0, dropping.y + 0) &&
            isEmpty(display, dropping.x + 0, dropping.y - 1) &&
            isEmpty(display, dropping.x + 0, dropping.y - 2)
        ) {
            display[dropping.y + 0][dropping.x - 1] = 5;
            display[dropping.y + 0][dropping.x + 0] = 5;
            display[dropping.y - 1][dropping.x + 0] = 5;
            display[dropping.y - 2][dropping.x + 0] = 5;
            return true;
        }
    }
    return false;
}

function overlayTetJ(display) {
    if (dropping.rotation == 0) {
        if (
            isEmpty(display, dropping.x - 2, dropping.y + 0) &&
            isEmpty(display, dropping.x - 1, dropping.y + 0) &&
            isEmpty(display, dropping.x + 0, dropping.y + 0) &&
            isEmpty(display, dropping.x + 0, dropping.y - 1)
        ) {
            display[dropping.y + 0][dropping.x - 2] = 6;
            display[dropping.y + 0][dropping.x - 1] = 6;
            display[dropping.y + 0][dropping.x + 0] = 6;
            display[dropping.y - 1][dropping.x + 0] = 6;
            return true;
        }
    } else if (dropping.rotation == 1) {
        if (
            isEmpty(display, dropping.x + 0, dropping.y - 2) &&
            isEmpty(display, dropping.x + 0, dropping.y - 1) &&
            isEmpty(display, dropping.x + 0, dropping.y + 0) &&
            isEmpty(display, dropping.x + 1, dropping.y + 0)
        ) {
            display[dropping.y - 2][dropping.x + 0] = 6;
            display[dropping.y - 1][dropping.x + 0] = 6;
            display[dropping.y + 0][dropping.x + 0] = 6;
            display[dropping.y + 0][dropping.x + 1] = 6;
            return true;
        }
    } else if (dropping.rotation == 2) {
        if (
            isEmpty(display, dropping.x + 0, dropping.y + 1) &&
            isEmpty(display, dropping.x + 0, dropping.y + 0) &&
            isEmpty(display, dropping.x + 1, dropping.y + 0) &&
            isEmpty(display, dropping.x + 2, dropping.y + 0)
        ) {
            display[dropping.y + 1][dropping.x + 0] = 6;
            display[dropping.y + 0][dropping.x + 0] = 6;
            display[dropping.y + 0][dropping.x + 1] = 6;
            display[dropping.y + 0][dropping.x + 2] = 6;
            return true;
        }
    } else if (dropping.rotation == 3) {
        if (
            isEmpty(display, dropping.x - 1, dropping.y + 0) &&
            isEmpty(display, dropping.x + 0, dropping.y + 0) &&
            isEmpty(display, dropping.x + 0, dropping.y + 1) &&
            isEmpty(display, dropping.x + 0, dropping.y + 2)
        ) {
            display[dropping.y + 0][dropping.x - 1] = 6;
            display[dropping.y + 0][dropping.x + 0] = 6;
            display[dropping.y + 1][dropping.x + 0] = 6;
            display[dropping.y + 2][dropping.x + 0] = 6;
            return true;
        }
    }
    return false;
}

function overlayTetT(display) {
    if (dropping.rotation == 0) {
        if (
            isEmpty(display, dropping.x - 1, dropping.y + 0) &&
            isEmpty(display, dropping.x + 0, dropping.y + 0) &&
            isEmpty(display, dropping.x + 0, dropping.y - 1) &&
            isEmpty(display, dropping.x + 1, dropping.y + 0)
        ) {
            display[dropping.y + 0][dropping.x - 1] = 7;
            display[dropping.y + 0][dropping.x + 0] = 7;
            display[dropping.y - 1][dropping.x + 0] = 7;
            display[dropping.y + 0][dropping.x + 1] = 7;
            return true;
        }
    } else if (dropping.rotation == 1) {
        if (
            isEmpty(display, dropping.x + 0, dropping.y - 1) &&
            isEmpty(display, dropping.x + 0, dropping.y + 0) &&
            isEmpty(display, dropping.x + 0, dropping.y + 1) &&
            isEmpty(display, dropping.x + 1, dropping.y + 0)
        ) {
            display[dropping.y - 1][dropping.x + 0] = 7;
            display[dropping.y + 0][dropping.x + 0] = 7;
            display[dropping.y + 1][dropping.x + 0] = 7;
            display[dropping.y + 0][dropping.x + 1] = 7;
            return true;
        }
    } else if (dropping.rotation == 2) {
        if (
            isEmpty(display, dropping.x - 1, dropping.y + 0) &&
            isEmpty(display, dropping.x + 0, dropping.y + 0) &&
            isEmpty(display, dropping.x + 1, dropping.y + 0) &&
            isEmpty(display, dropping.x + 0, dropping.y + 1)
        ) {
            display[dropping.y + 0][dropping.x - 1] = 7;
            display[dropping.y + 0][dropping.x + 0] = 7;
            display[dropping.y + 0][dropping.x + 1] = 7;
            display[dropping.y + 1][dropping.x + 0] = 7;
            return true;
        }
    } else if (dropping.rotation == 3) {
        if (
            isEmpty(display, dropping.x + 0, dropping.y - 1) &&
            isEmpty(display, dropping.x + 0, dropping.y + 0) &&
            isEmpty(display, dropping.x + 0, dropping.y + 1) &&
            isEmpty(display, dropping.x - 1, dropping.y + 0)
        ) {
            display[dropping.y - 1][dropping.x + 0] = 7;
            display[dropping.y + 0][dropping.x + 0] = 7;
            display[dropping.y + 1][dropping.x + 0] = 7;
            display[dropping.y + 0][dropping.x - 1] = 7;
            return true;
        }
    }
    return false;
}

function isEmpty(display, x, y) {
    if (x < 0 || x >= WIDTH) {
        return false;
    }
    if (y >= HEIGHT) {
        return false;
    }
    if (y >= 0) {
        return display[y][x] === 0;
    }
    return false;
}

function printField(display) {
    let html = '';
    for (let h = 0; h < HEIGHT; h++) {
        for (let w = 0; w < WIDTH; w++) {
            const type = display[h][w];
            html += '<span class="block block';
            html += type;
            html += '"></span>';
        }
        html += '<br>';
    }
    document.getElementById('field').innerHTML = html;
}

function onKeyDown(ev) {
    switch (ev.keyCode) {
    case 37: // left
        moveLeft();
        break;
    case 39: // right
        moveRight();
        break;
    case 90: // z
    case 38: // up
        rotateLeft();
        break;
    case 88: // x
        rotateRight();
        break;
    case 40: // down
    case 32: // space
        dropIt();
        break;
    }
}

function dropIt() {
    dropping.y += 1;
    const display = JSON.parse(JSON.stringify(field));
    if (overlayDropping(display)) {
        printField(display);
    } else {
        dropping.y -= 1;
        onDrop();
    }
}

function moveRight() {
    dropping.x += 1;
    const display = JSON.parse(JSON.stringify(field));
    if (overlayDropping(display)) {
        printField(display);
    } else {
        dropping.x -= 1;
    }
}

function moveLeft() {
    dropping.x -= 1;
    const display = JSON.parse(JSON.stringify(field));
    if (overlayDropping(display)) {
        printField(display);
    } else {
        dropping.x += 1;
    }
}

function rotateRight() {
    const before = dropping.rotation;
    dropping.rotation += 1;
    if (dropping.rotation > 3) {
        dropping.rotation = 0;
    }
    const display = JSON.parse(JSON.stringify(field));
    if (overlayDropping(display)) {
        printField(display);
    } else {
        dropping.rotation = before;
    }
}

function rotateLeft() {
    const before = dropping.rotation;
    dropping.rotation -= 1;
    if (dropping.rotation < 0) {
        dropping.rotation = 3;
    }
    const display = JSON.parse(JSON.stringify(field));
    if (overlayDropping(display)) {
        printField(display);
    } else {
        dropping.rotation = before;
    }
}

function tick() {
    const display = JSON.parse(JSON.stringify(field));
    dropping.y += 1;
    if (overlayDropping(display)) {
        printField(display);
    } else {
        dropping.y -= 1;
        onDrop();
    }
}

function onDrop() {
    const display = JSON.parse(JSON.stringify(field));
    overlayDropping(display);
    field = JSON.parse(JSON.stringify(display));
    printField(display);
    dropping = nextBlock;
    nextBlock = makeNextBlock();
    setTimeout(scanLines, 100);
}

function scanLines() {
    let nextField = new Array();
    for (let y = HEIGHT - 1; y >= 0; y--) {
        let filled = true;
        const line = field[y];
        for (let x = 0; x < WIDTH; x++) {
            if (line[x] === 0) {
                filled = false;
                break;
            }
        }
        if (!filled) {
            nextField.unshift(line);
        }
    }
    while (nextField.length < HEIGHT) {
        const line = new Array(WIDTH);
        for (let x = 0; x < WIDTH; x++) {
            line[x] = 0;
        }
        nextField.unshift(line);
    }
    field = nextField;
}

document.addEventListener('keydown', onKeyDown);
setInterval(tick, 500);
</script>
</body>
</html>
